# Theoretical Background

Ensemble Analyzer (EnAn) streamlines the processing of conformational ensembles by integrating geometric filtering, unsupervised clustering, and advanced thermochemical corrections. This section details the physical and mathematical models implemented in the software.

## 1. Conformational Pruning Strategy

A critical bottleneck in conformational analysis is the redundancy of structures generated by stochastic search algorithms. EnAn implements a computationally efficient **dual-filter** to remove duplicates without requiring expensive RMSD (Root-Mean-Square Deviation) superposition for every pair.

### 1.1 Energy Filtering (The "Window")
The first tier of filtering acts on the electronic energy ($\Delta E$). Given the global minimum found so far ($E_{min}$), any conformer $i$ is discarded if:

$$
(E_i - E_{min}) > \text{thr}G_\text{max}
$$

This ensures that only chemically relevant conformers (accessible at thermal equilibrium) are processed.

### 1.2 Geometric Filtering: Rotational Constants
To identify duplicates, EnAn utilizes **Rotational Constants** as geometric descriptors. Rotational constants depend on the principal moments of inertia ($I$) and are invariant to translation and rotation of the molecular frame.

Two conformers $i$ (check) and $j$ (reference) are defined as **identical** if they satisfy *both* conditions:

1.  **Energy Equivalence**:
    $$|E_i - E_j| < \text{thrG}$$
2.  **Geometric Equivalence**:
    $$|B_i - B_j| < \text{thrB}$$

Where $B$ is the scalar norm of the rotational constant vector. This method reduces the complexity from $O(N^2)$ RMSD alignments to simple scalar comparisons.

> **Note**: An invariant RMSD based on EDM eigenvalues is calculated for logged duplicates.

---

## 2. Invariant Clustering Algorithm

For structural classification and ensemble reduction, EnAn moves away from Cartesian coordinate dependence to avoid alignment issues. It employs the **Spectrum of the Euclidean Distance Matrix (EDM)**.

### 2.1 The Euclidean Distance Matrix
For a molecule with $N$ atoms, the EDM ($\mathbf{D}$) is an $N \times N$ symmetric matrix where each element represents the squared Euclidean distance between atom $i$ and atom $j$:

$$
D_{ij} = ||\mathbf{r}_i - \mathbf{r}_j||^2
$$

### 2.2 Eigenvalues as Descriptors
The set of eigenvalues $\{\lambda_1, \lambda_2, \dots, \lambda_N\}$ of the matrix $\mathbf{D}$ is invariant to:
* Translation
* Rotation
* Atom numbering (permutations, if sorted)

This eigenvalue vector serves as the input feature vector for **Principal Component Analysis (PCA)**. The resulting Principal Components (PCs) are then fed into a **K-Means** clustering algorithm. The optimal number of clusters ($k$) is automatically determined using the **Silhouette Score**.

---

## 3. Thermochemistry: The qRRHO Approximation

Standard Rigid-Rotor Harmonic Oscillator (RRHO) approximations often fail for flexible molecules with low-frequency vibrational modes ($< 100 \text{ cm}^{-1}$), leading to infinite entropy errors.

EnAn implements the **Quasi-Rigid Rotor Harmonic Oscillator (qRRHO)** approximation described by [Grimme (2012)](https://doi.org/10.1002/chem.201200497).

### 3.1 Entropy Interpolation
The vibrational entropy $S_{vib}$ is calculated by interpolating between the harmonic oscillator entropy ($S_{HO}$) and the free-rotor entropy ($S_{rot}$) using a damping function dependent on the frequency $\omega$:

$$
S_{vib}(\omega) = w(\omega) S_{HO}(\omega) + [1 - w(\omega)] S_{rot}(\omega)
$$

The damping function $w(\omega)$ is defined as:

$$
w(\omega) = \frac{1}{1 + (\omega_0 / \omega)^\alpha}
$$

where $\omega_0$ is the cut-off frequency (default: $100 \text{ cm}^{-1}$) and $\alpha$ is the damping power (default: 4). This correction ensures that low-frequency modes contribute physically meaningful entropy values to the final Gibbs Free Energy ($G$).

---

## 4. Boltzmann Weighting and Spectra

Final spectral properties are computed as a Boltzmann-weighted average of the individual active conformers.

### 4.1 Population Calculation
The probability $p_i$ of finding the system in conformer $i$ at temperature $T$ is derived from the relative Gibbs Free Energy ($\Delta G_i$):

$$
p_i = \frac{e^{-\Delta G_i / k_B T}}{\sum_j e^{-\Delta G_j / k_B T}}
$$

### 4.2 Spectral Convolution
EnAn distinguishes between vibronic and electronic spectra for the convolution function $f(\nu, \nu_0, \sigma)$:

1.  **Vibronic Spectra (IR, VCD)**:
    Use a **Lorentzian** line-shape function to model lifetime broadening:

    $$
    f_\text{Lorentz}(x; x_0, \gamma) = \frac{\text{FWHM}^2}{\text{FWHM}^2 + 4(x - x_0)^2}
    $$

2.  **Electronic Spectra (UV-Vis, ECD)**:
    Use a **Gaussian** line-shape function to model inhomogeneous broadening:

    $$
    f_\text{Gauss}(x; x_0, \sigma) = \frac{1}{\sigma\sqrt{2\pi}} e^{ -\frac{1}{2}\left(\frac{x-x_0}{\sigma}\right)^2 }
    $$

The final intensity $I_{total}(\nu)$ is the weighted sum:

$$
I_\text{total}(\nu) = \sum_i^{N_{conf}} p_i \sum_k^{N_{modes}} I_{i,k} \cdot f(\nu, \nu_{i,k}, \text{FWHM})
$$