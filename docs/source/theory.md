# Theoretical Background

Ensemble Analyzer (EnAn) streamlines the processing of conformational ensembles by integrating geometric filtering, unsupervised clustering, and advanced thermochemical corrections. This section details the physical and mathematical models implemented in the software.

## 1. Conformational Pruning Strategy

A critical bottleneck in conformational analysis is the redundancy of structures generated by stochastic search algorithms (e.g., CREST, conformational searches). EnAn implements a computationally efficient **dual-filter** to remove duplicates without requiring expensive RMSD (Root-Mean-Square Deviation) superposition for every pair.

### 1.1 Energy Filtering
The first tier of filtering is based on electronic energy ($\Delta E_{el}$). Given a reference conformer $i$ and a candidate $j$:

$$
|\Delta E_{ij}| = |E_i - E_j|
$$

If $|\Delta E_{ij}| > \text{thr}_{G}$, the structures are considered distinct in potential energy surface (PES) exploration.

### 1.2 Geometric Filtering: Rotational Constants
To avoid the $O(N^2)$ complexity of aligning structures for RMSD calculation, EnAn utilizes **Rotational Constants** as geometric descriptors. Rotational constants ($B$) are inversely proportional to the principal moments of inertia ($I$) and are invariant to translation and rotation of the molecular frame.

$$
B_k = \frac{h}{8\pi^2 c I_k} \quad \text{where } k \in \{A, B, C\}
$$

Two conformers are defined as geometrically identical if:
1.  They satisfy the energy threshold.
2.  The deviation in their rotational constants is below a defined threshold ($\text{thr}_{B}$):

$$
||B_A||^2 - ||B_B||^2 < \text{thr}_{B}
$$

This method is significantly faster than coordinate-based RMSD while remaining robust for rigid and semi-rigid backbones.

---

## 2. Invariant Clustering Algorithm

For structural classification, EnAn moves away from Cartesian coordinate dependence. Instead, it employs the **Spectrum of the Euclidean Distance Matrix (EDM)**.

### 2.1 The Euclidean Distance Matrix
For a molecule with $N$ atoms, the EDM ($\mathbf{D}$) is an $N \times N$ symmetric matrix where each element represents the squared Euclidean distance between atom $i$ and atom $j$:

$$
D_{ij} = ||\mathbf{r}_i - \mathbf{r}_j||^2
$$

### 2.2 Eigenvalues as Descriptors
The set of eigenvalues $\{\lambda_1, \lambda_2, \dots, \lambda_N\}$ of the centered EDM is invariant to:
* Translation
* Rotation
* Atom numbering (permutations)

This makes the eigenvalue vector an ideal feature set for unsupervised learning algorithms (e.g., K-Means, Agglomerative Clustering) to group conformers into structural families without manual alignment.

---

## 3. Thermochemistry: The qRRHO Approximation

Standard Rigid-Rotor Harmonic Oscillator (RRHO) approximations often fail for flexible molecules with low-frequency vibrational modes ($< 100 \text{ cm}^{-1}$), leading to infinite entropy errors.

EnAn implements the **Quasi-Rigid Rotor Harmonic Oscillator (qRRHO)** approximation described by [Grimme (2012)](https://doi.org/10.1002/chem.201200497).

### 3.1 Entropy Interpolation
The vibrational entropy $S_{vib}$ is calculated by interpolating between the harmonic oscillator entropy ($S_{HO}$) and the free-rotor entropy ($S_{rot}$) using a damping function dependent on the frequency $\omega$:

$$
S_{vib}(\omega) = w(\omega) S_{HO}(\omega) + [1 - w(\omega)] S_{rot}(\omega)
$$

This correction ensures that low-frequency modes contribute physically meaningful entropy values to the final Gibbs Free Energy ($G$).

---

## 4. Boltzmann Weighting and Spectra

Final spectral properties (IR, VCD, UV-Vis, ECD) are computed as a Boltzmann-weighted average of the individual conformers.

### 4.1 Population Calculation
The probability $p_i$ of finding the system in conformer $i$ at temperature $T$ is:

$$
p_i = \frac{e^{-\Delta G_i / k_B T}}{Z} \quad \text{with} \quad Z = \sum_j e^{-\Delta G_j / k_B T}
$$

Where $\Delta G_i$ is the relative Gibbs Free Energy calculated using the qRRHO correction.

### 4.2 Spectral Convolution
Continuous spectra are generated by convolving the discrete transitions with broadening functions (Lorentzian or Gaussian). For a generic property $I(\nu)$ (e.g., absorption intensity) at frequency $\nu$:

$$
I_\text{total}(\nu) = \sum_i^{N_{conf}} p_i \sum_k^{N_{modes}} I_{i,k} \cdot f(\nu, \nu_{i,k}, \sigma)
$$

Where $f$ is the line-shape function and $\sigma$ is the Full Width at Half Maximum (FWHM).